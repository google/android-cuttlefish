load("//cuttlefish/bazel:rules.bzl", "cf_cc_library", "cf_cc_test")

package(
    default_visibility = ["//:android_cuttlefish"],
)

exports_files([".clang-tidy"])

cf_cc_library(
    name = "buffered_zip_source",
    srcs = ["buffered_zip_source.cc"],
    hdrs = ["buffered_zip_source.h"],
    deps = [
        "//cuttlefish/common/libs/utils:result",
        "//cuttlefish/host/libs/zip:zip_cc",
    ],
)

cf_cc_test(
    name = "buffered_zip_source_test",
    srcs = ["buffered_zip_source_test.cc"],
    deps = [
        "//cuttlefish/common/libs/utils:result",
        "//cuttlefish/common/libs/utils:result_matchers",
        "//cuttlefish/host/libs/zip:buffered_zip_source",
        "//cuttlefish/host/libs/zip:zip_cc",
        "@googletest//:gtest",
        "@googletest//:gtest_main",
    ],
)

cf_cc_library(
    name = "cached_zip_source",
    srcs = ["cached_zip_source.cc"],
    hdrs = ["cached_zip_source.h"],
    deps = [
        "//cuttlefish/common/libs/utils:result",
        "//cuttlefish/host/libs/zip:lazily_loaded_file",
        "//cuttlefish/host/libs/zip:zip_cc",
        "//libbase",
    ],
)

cf_cc_test(
    name = "cached_zip_source_test",
    srcs = ["cached_zip_source_test.cc"],
    deps = [
        "//cuttlefish/common/libs/fs",
        "//cuttlefish/common/libs/utils:result",
        "//cuttlefish/common/libs/utils:result_matchers",
        "//cuttlefish/host/libs/zip:cached_zip_source",
        "//cuttlefish/host/libs/zip:zip_cc",
        "//cuttlefish/host/libs/zip:zip_string",
        "@googletest//:gtest",
        "@googletest//:gtest_main",
    ],
)

cf_cc_library(
    name = "disjoint_range_set",
    srcs = ["disjoint_range_set.cc"],
    hdrs = ["disjoint_range_set.h"],
    deps = [
        "//libbase",
    ],
)

proto_library(
    name = "disjoint_range_set_proto",
    srcs = ["disjoint_range_set.proto"],
)

cc_proto_library(
    name = "disjoint_range_set_cc_proto",
    deps = ["//cuttlefish/host/libs/zip:disjoint_range_set_proto"],
)

cf_cc_test(
    name = "disjoint_range_set_test",
    srcs = ["disjoint_range_set_test.cc"],
    deps = [
        "//cuttlefish/host/libs/zip:disjoint_range_set",
        "@googletest//:gtest",
        "@googletest//:gtest_main",
    ],
)

cf_cc_library(
    name = "lazily_loaded_file",
    srcs = ["lazily_loaded_file.cc"],
    hdrs = ["lazily_loaded_file.h"],
    deps = [
        "//cuttlefish/common/libs/fs",
        "//cuttlefish/common/libs/utils:files",
        "//cuttlefish/common/libs/utils:result",
        "//cuttlefish/host/libs/zip:disjoint_range_set",
        "//cuttlefish/host/libs/zip:serialize_disjoint_range_set",
        "//libbase",
    ],
)

cf_cc_library(
    name = "remote_zip",
    srcs = ["remote_zip.cc"],
    hdrs = ["remote_zip.h"],
    deps = [
        "//cuttlefish/common/libs/utils:result",
        "//cuttlefish/host/libs/web/http_client",
        "//cuttlefish/host/libs/zip:zip_cc",
        "@abseil-cpp//absl/strings",
        "@fmt",
    ],
)

cf_cc_test(
    name = "remote_zip_test",
    srcs = ["remote_zip_test.cc"],
    deps = [
        "//cuttlefish/common/libs/utils:result",
        "//cuttlefish/common/libs/utils:result_matchers",
        "//cuttlefish/host/libs/web/http_client",
        "//cuttlefish/host/libs/web/http_client:fake_http_client",
        "//cuttlefish/host/libs/zip:remote_zip",
        "//cuttlefish/host/libs/zip:zip_cc",
        "//cuttlefish/host/libs/zip:zip_string",
        "@abseil-cpp//absl/strings",
        "@googletest//:gtest",
        "@googletest//:gtest_main",
    ],
)

cf_cc_library(
    name = "serialize_disjoint_range_set",
    srcs = ["serialize_disjoint_range_set.cc"],
    hdrs = ["serialize_disjoint_range_set.h"],
    deps = [
        "//cuttlefish/common/libs/utils:result",
        "//cuttlefish/host/libs/zip:disjoint_range_set",
        "//cuttlefish/host/libs/zip:disjoint_range_set_cc_proto",
    ],
)

cf_cc_test(
    name = "serialize_disjoint_range_set_test",
    srcs = ["serialize_disjoint_range_set_test.cc"],
    deps = [
        "//cuttlefish/common/libs/utils:result",
        "//cuttlefish/common/libs/utils:result_matchers",
        "//cuttlefish/host/libs/zip:disjoint_range_set",
        "//cuttlefish/host/libs/zip:serialize_disjoint_range_set",
        "@googletest//:gtest",
        "@googletest//:gtest_main",
    ],
)

cf_cc_library(
    name = "zip_cc",
    srcs = ["zip_cc.cc"],
    hdrs = ["zip_cc.h"],
    features = ["-layering_check"],  # libzip
    linkopts = ["-llzma"],  # libzip
    linkstatic = True,  # libzip
    deps = [
        "//cuttlefish/common/libs/utils:result",
        "@libzip",
        "@zlib",
    ],
)

cf_cc_library(
    name = "zip_copy",
    srcs = ["zip_copy.cc"],
    hdrs = ["zip_copy.h"],
    deps = [
        "//cuttlefish/common/libs/utils:result",
        "//cuttlefish/host/libs/zip:zip_cc",
    ],
)

cf_cc_test(
    name = "zip_copy_test",
    srcs = ["zip_copy_test.cc"],
    deps = [
        "//cuttlefish/common/libs/utils:result",
        "//cuttlefish/common/libs/utils:result_matchers",
        "//cuttlefish/host/libs/zip:zip_cc",
        "//cuttlefish/host/libs/zip:zip_copy",
        "//cuttlefish/host/libs/zip:zip_string",
        "@googletest//:gtest",
        "@googletest//:gtest_main",
    ],
)

cf_cc_library(
    name = "zip_file",
    srcs = ["zip_file.cc"],
    hdrs = ["zip_file.h"],
    deps = [
        "//cuttlefish/common/libs/utils:files",
        "//cuttlefish/common/libs/utils:result",
        "//cuttlefish/host/libs/zip:zip_cc",
        "//cuttlefish/host/libs/zip:zip_copy",
    ],
)

cf_cc_library(
    name = "zip_string",
    srcs = ["zip_string.cc"],
    hdrs = ["zip_string.h"],
    deps = [
        "//cuttlefish/common/libs/utils:result",
        "//cuttlefish/host/libs/zip:zip_cc",
    ],
)
