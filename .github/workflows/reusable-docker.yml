name: Reusable Docker Container Run

on:
  workflow_call:
    secrets:
      token:
        required: true
    inputs:
      docker-image:
        required: true
        type: string
      platform:
        default: linux/amd64
        required: false
        type: string
    outputs:
      builder:
        value: ${{ jobs.docker-run.outputs.builder }}
        description: "Build output"
      testing:
        value: ${{ jobs.docker-run.outputs.testing }}
        description: "Test output"
      integration:
        value: ${{ jobs.docker-run.outputs.integration }}
        description: "Test output"
      orchestration:
        value: ${{ jobs.docker-run.outputs.orchestration }}
        description: "Test output"
jobs:

  docker-run:
    runs-on: ubuntu-latest
    outputs:
      builder: ${{ steps.build-rpm-packages.outputs.result }}
      testing: ${{ steps.test-rpm-packages.outputs.result }}
      integration: ${{ steps.test-integration.outputs.result }}
      orchestration: ${{ steps.test-orchestration.outputs.result }}

    steps:

      # https://github.com/docker/login-action
      - name: Log in to the Container registry
        uses: 'docker/login-action@v3'
        id: container-registry
        with:
          registry: ghcr.io
          username: ${{ GITHUB.ACTOR }}
          password: ${{ SECRETS.TOKEN }}

      # https://docs.docker.com/reference/cli/docker/container/run/
      # https://docs.docker.com/reference/cli/docker/container/cp/
      # --entrypoint ${{ INPUTS.ENTRY-POINT }} cannot be changed with GitHub docker.
      - name: Run docker and somehow extract the archive from the volume.
        if: ${{ contains(INPUTS.DOCKER-IMAGE, 'builder') }}
        id: build-rpm-packages
        env:
          RPM_PLATFORM: ${{ INPUTS.PLATFORM }}
        run: |
          docker run --name rpm-builder --env RPM_PLATFORM=$RPM_PLATFORM --quiet $RPM_PLATFORM
          VOLUME_HASH=$(docker volume ls --filter driver="local" --format '{{.Name}}')
          DIRECTORY=/var/lib/docker/volumes/$VOLUME_HASH/_data
          CID=`docker ps -aqf "name=^rpm-builder$"`
          echo Listing container $CID with attached volume: /var/lib/docker/volumes/$VOLUME/_data

          # TODO: Finds nothing, because the entrypoint.sh does not seem to execute.
          # docker cp $CID:/root/android-cuttlefish-rpm.tar.gz ${{ RUNNER.TEMP }}
          # docker cp rpm-builder:/root/android-cuttlefish-rpm.tar.gz ${{ RUNNER.TEMP }}
          sudo ls -la $DIRECTORY
          cp $DIRECTORY/android-cuttlefish-rpm.tar.gz ${{ RUNNER.TEMP }}
          
          # Cleanup
          docker rm rpm-builder
          echo "result=ok" >> $GITHUB_OUTPUT

      # https://github.com/actions/upload-artifact
      - name: Retain Artifacts (*.rpm)
        if: ${{ contains(INPUTS.DOCKER-IMAGE, 'builder') }}
        uses: 'actions/upload-artifact@v4'
        id: retain-rpm-packages
        with:
          path: ${{ RUNNER.TEMP }}/*.tar.gz
          name: android-cuttlefish-rhel
          retention-days: 14

      # https://docs.docker.com/reference/cli/docker/container/run/
      - name: Run package tests
        if: ${{ contains(INPUTS.DOCKER-IMAGE, 'testing') }}
        id: test-rpm-packages
        run: |
          docker run --name rpm-testing --quiet ${{ INPUTS.DOCKER-IMAGE }}
          docker rm rpm-testing
          echo "result=ok" >> $GITHUB_OUTPUT

      # https://docs.docker.com/reference/cli/docker/container/run/
      - name: Run integration test
        if: ${{ contains(INPUTS.DOCKER-IMAGE, 'integration') }}
        id: test-integration
        run: |
          docker run --name rhel-integration --quiet ${{ INPUTS.DOCKER-IMAGE }}
          echo "result=ok" >> $GITHUB_OUTPUT

      # https://docs.docker.com/reference/cli/docker/container/run/
      - name: Run orchestration test
        if: ${{ contains(INPUTS.DOCKER-IMAGE, 'orchestration') }}
        id: test-orchestration
        run: |
          docker run --name rhel-orchestration --quiet ${{ INPUTS.DOCKER-IMAGE }}
          echo "result=ok" >> $GITHUB_OUTPUT
