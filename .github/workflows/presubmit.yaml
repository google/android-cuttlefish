name: ExperimentalCheckKVM

on: [pull_request, push]

jobs:
  cvd-start:
    runs-on: ubuntu-22.04
    steps:
    - name: Check kvm in host 
      run: |
        ls /dev/kvm
    - name: Checkout repository
      uses: actions/checkout@a81bbbf8298c0fa03ea29cdc473d45769f953675 # aka v2
      with:
        ref: ${{ github.event.pull_request.head.sha }}
    - name: Build Docker Image
      run: |
        cd "${GITHUB_WORKSPACE}/docker/arm-server"
        bash build.sh
    - name: Run Test 
      run: |
        container=$(docker run --privileged -d -p 12080:2080 -p 11443:1443 -p 12443:2443 -it cuttlefish-arm64)
        sleep 60
        docker ps
        docker container logs "${container}"
    - name: Make requests
      run: |
        docker ps
        curl http://localhost:12080/_debug/statusz
        curl http://localhost:12080/cvds
        curl -d '{"cvd":{"build_source":{"android_ci_build_source":{"main_build":{"branch":"aosp-main","target":"aosp_cf_x86_64_phone-trunk_staging-userdebug"}}}}}' --header "Content-Type: application/json" --request POST http://localhost:12080/cvds
        sleep 360
        curl http://localhost:12080/cvds
        docker ps
        name=$(docker container ls | awk '{print $1}' | tail -n 1)
        docker container logs "${name}"





