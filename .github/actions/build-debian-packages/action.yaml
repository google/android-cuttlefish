name: 'Build debian packages for Cuttlefish host'
inputs:
  deploy-channel:
    required: false
  yyyymmddhhmm:
    required: false
runs:
  using: "composite"
  steps:
  - name: Modify version format
    if: inputs.deploy-channel != ''
    run: |
      case "${INPUTS_DEPLOY_CHANNEL}" in
        stable)
          # Stable version format : X.Y.Z
          SEMVER=$(echo ${GITHUB_REF_NAME} | grep -oE '[0-9]+.[0-9]+.[0-9]+')
          sed -i "1s/(\([0-9]\+.[0-9]\+.[0-9]\+\))/(${SEMVER})/g" \
            base/debian/changelog
          sed -i "1s/(\([0-9]\+.[0-9]\+.[0-9]\+\))/(${SEMVER})/g" \
            frontend/debian/changelog
          sed -i "1s/(\([0-9]\+.[0-9]\+.[0-9]\+\))/(${SEMVER})/g" \
            cuttlefish-integration-gigabyte-arm64/debian/changelog
          ;;
        unstable|nightly)
          # Unstable/nightly version format : X.Y.Z~gitYYYYMMDDHHMM.<Github SHA 8 digit>
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-8)
          SUFFIX="~git${INPUTS_YYYYMMDDHHMM}.${SHORT_SHA}"
          sed -i "1s/(\([0-9]\+.[0-9]\+.[0-9]\+\))/(\1${SUFFIX})/g" \
            base/debian/changelog
          sed -i "1s/(\([0-9]\+.[0-9]\+.[0-9]\+\))/(\1${SUFFIX})/g" \
            frontend/debian/changelog
          sed -i "1s/(\([0-9]\+.[0-9]\+.[0-9]\+\))/(\1${SUFFIX})/g" \
            cuttlefish-integration-gigabyte-arm64/debian/changelog
          ;;
        *)
          exit 1
          ;;
      esac
    shell: bash
    env:
      INPUTS_DEPLOY_CHANNEL: ${{ inputs.deploy-channel }}
      INPUTS_YYYYMMDDHHMM: ${{ inputs.yyyymmddhhmm }}
  - name: Build CF debian packages
    run: |
      sudo docker build --file "tools/buildutils/cw/Containerfile" --tag "android-cuttlefish-build" .
      sudo docker run -v=$PWD:/mnt/build -w /mnt/build -v=$HOME/bazel-disk-cache:/root/bazel-disk-cache android-cuttlefish-build base -d /root/bazel-disk-cache
      sudo docker run -v=$PWD:/mnt/build -w /mnt/build android-cuttlefish-build frontend
      sudo docker run -v=$PWD:/mnt/build -w /mnt/build android-cuttlefish-build cuttlefish-integration-gigabyte-arm64
    shell: bash
